package repositoryimpl

import (
	"github.com/google/uuid"
	"github.com/lib/pq"

	"github.com/opensourceways/cve-manager/cve/domain"
	"github.com/opensourceways/cve-manager/utils"
)

type basePkgDO struct {
	Id          uuid.UUID      `gorm:"column:uuid;type:uuid"                    json:"-"`
	Org         string         `gorm:"column:org"                               json:"-"`
	Repo        string         `gorm:"column:repo"                              json:"repo"`
	Platform    string         `gorm:"column:platform"                          json:"-"`
	Community   string         `gorm:"column:community"                         json:"-"`
	CreatedAt   string         `gorm:"column:created_at"                        json:"-"`
	UpdatedAt   string         `gorm:"column:updated_at"                        json:"updated_at"`
	Decription  string         `gorm:"column:decription"                        json:"decription"`
	PackageName string         `gorm:"column:package_name"                      json:"-"`
	Branch      pq.StringArray `gorm:"column:branch;type:text[];default:'{}'"   json:"-"`
}

func (c communityPkgImpl) toBasePkgDO(pkg *domain.BasePackage, do *basePkgDO) {
	*do = basePkgDO{
		Id:          uuid.New(),
		Org:         pkg.Repository.Org,
		Repo:        pkg.Repository.Repo,
		Platform:    pkg.Repository.Platform,
		Community:   pkg.Repository.Community.Community(),
		Decription:  pkg.Repository.Desc.PackageDescription(),
		PackageName: pkg.Name.PackageName(),
		CreatedAt:   utils.ToDate(utils.Now()),
		UpdatedAt:   utils.ToDate(utils.Now()),
		Branch:      toStringArray(pkg.Branches),
	}
}

func toStringArray(v []domain.BasePackageBranch) (pq pq.StringArray) {
	pq = make([]string, len(v))

	for i := range v {
		pq[i] = v[i].String()
	}

	return
}
